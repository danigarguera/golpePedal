import{a as A}from"./chunk-45IF2TN7.js";import{a as N}from"./chunk-E5SSPYM6.js";import{a as V}from"./chunk-ATC3HXFD.js";import{B as d,C as I,Da as w,G as p,J as s,M as t,N as r,O as h,R as _,S as E,T as u,V as F,W as i,X as c,Y as v,Z as P,_ as y,ea as f,ga as x,ia as g,ja as z,q as C,qa as D,r as b,ra as T,ta as O,ua as R,z as a}from"./chunk-YAXSTRSO.js";var S=n=>[n,"EUR","symbol","1.2-2","es-ES"];function j(n,o){if(n&1&&(t(0,"span"),i(1),r()),n&2){let e=u(2);a(),v(", piso ",e.direccion.piso,"")}}function k(n,o){if(n&1&&(t(0,"tr")(1,"td"),i(2),r(),t(3,"td"),i(4),r(),t(5,"td"),i(6),x(7,"currency"),r(),t(8,"td"),i(9),x(10,"currency"),r()()),n&2){let e=o.$implicit;a(2),c(e.nombre),a(2),c(e.cantidad),a(2),c(g(7,4,f(16,S,e.precio))),a(3),c(g(10,10,f(18,S,e.precio*e.cantidad)))}}function B(n,o){if(n&1){let e=_();t(0,"div",2)(1,"h2",3),i(2,"Revisar y confirmar pedido"),r(),t(3,"div",4)(4,"div",5)(5,"strong"),i(6,"Direcci\xF3n de env\xEDo"),r()(),t(7,"div",6)(8,"p")(9,"strong"),i(10),r()(),t(11,"p"),i(12),p(13,j,2,1,"span",7),h(14,"br"),i(15),h(16,"br"),i(17),r()()(),t(18,"div",8)(19,"h4",9),i(20,"Productos en el pedido"),r(),t(21,"table",10)(22,"thead",11)(23,"tr")(24,"th"),i(25,"Producto"),r(),t(26,"th"),i(27,"Cantidad"),r(),t(28,"th"),i(29,"Precio unitario"),r(),t(30,"th"),i(31,"Subtotal"),r()()(),t(32,"tbody"),p(33,k,11,20,"tr",12),r()(),t(34,"div",13)(35,"h5"),i(36),x(37,"currency"),r()()(),t(38,"div",14)(39,"button",15),E("click",function(){C(e);let m=u();return b(m.finalizarCompra())}),i(40,"Finalizar compra"),r()()()}if(n&2){let e=u();a(10),c(e.direccion.alias),a(2),P(" ",e.direccion.calle,", ",e.direccion.numero," "),a(),s("ngIf",e.direccion.piso),a(2),y(" ",e.direccion.codigoPostal," ",e.direccion.ciudad," (",e.direccion.provincia,")"),a(2),v(" ",e.direccion.pais," "),a(16),s("ngForOf",e.carrito),a(3),v("Total: ",g(37,10,f(16,S,e.totalPedido)),"")}}function M(n,o){n&1&&(t(0,"div",16),i(1," Cargando datos del pedido o sesi\xF3n inv\xE1lida. Por favor vuelve al carrito. "),r())}var U=class n{constructor(o,e,l,m){this.carritoService=o;this.pedidoService=e;this.authService=l;this.router=m}carrito=[];direccion;usuarioId=0;ngOnInit(){this.authService.getUsuarioActual().subscribe({next:o=>{if(this.usuarioId=o.id,this.direccion=history.state.direccionSeleccionada??null,!this.direccion){alert("No se ha seleccionado una direcci\xF3n"),this.router.navigate(["/seleccionar-direccion"]);return}if(this.carrito=this.carritoService.obtenerCarrito(),this.carrito.length===0){alert("Tu carrito est\xE1 vac\xEDo"),this.router.navigate(["/carrito"]);return}},error:()=>{alert("Debes iniciar sesi\xF3n"),this.router.navigate(["/login"])}})}get totalPedido(){return this.carrito.reduce((o,e)=>o+e.precio*e.cantidad,0)}finalizarCompra(){let o={usuarioId:this.usuarioId,direccionId:this.direccion.id,lineas:this.carrito.map(e=>({componenteId:e.id,cantidad:e.cantidad,precioUnitario:e.precio}))};console.log("\u{1F4E6} Enviando pedido:",o),this.pedidoService.crearPedido(o).subscribe({next:e=>{console.log("\u2705 Pedido creado correctamente:",e),this.carritoService.vaciarCarrito(),this.router.navigate(["/pedido",e.id],{state:{pedido:e}})},error:e=>{console.error("\u274C Error al crear pedido:",e),alert("Hubo un error al finalizar el pedido.")}})}static \u0275fac=function(e){return new(e||n)(d(A),d(V),d(N),d(w))};static \u0275cmp=I({type:n,selectors:[["app-finalizar-compra"]],decls:3,vars:2,consts:[["cargando",""],["class","container mt-4",4,"ngIf","ngIfElse"],[1,"container","mt-4"],[1,"texto-grande","fw-bold"],[1,"card","mt-4","sombra-suave","borde-claro","rounded-3"],[1,"card-header","bg-light"],[1,"card-body"],[4,"ngIf"],[1,"mt-4"],[1,"fw-semibold"],[1,"table","table-bordered","table-striped"],[1,"table-light"],[4,"ngFor","ngForOf"],[1,"text-end","mt-3"],[1,"mt-4","text-end"],[1,"btn","btn-secundario",3,"click"],[1,"alert","alert-warning","mt-4"]],template:function(e,l){if(e&1&&p(0,B,41,18,"div",1)(1,M,2,0,"ng-template",null,0,z),e&2){let m=F(2);s("ngIf",l.direccion&&l.carrito.length>0)("ngIfElse",m)}},dependencies:[R,D,T,O],encapsulation:2})};export{U as FinalizarCompraComponent};
